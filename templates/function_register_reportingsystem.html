{% extends "layout.html" %}

{% block content %}
    <h2>Register a <em>Reporting System</em></h2>
    <p>This page allows someone to register a <a class="definition" href="http://promsns.org/def/proms#ReportingSystem">Report</a> allowing that ReportingSystem to send data to this PROMS Server instance in the form of <a class="definition" href="http://promsns.org/def/proms#Report"><em>Reports</em></a>.</p>
    <p>Complete the form below to register a <em>ReportingSystem</em>. Input validation will ensure that the <em>ReportingSystem</em> registered is valid, i.e. that all the metadata by the <a class="definition" href="http://promsns.org/def/proms">PROMS ontology</a> is supplied.</p>

    <script src="/static/js/jquery.min.js" charset="utf-8"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/jquery.datetimepicker.css"/ >
    <script src="/static/js/jquery.datetimepicker.js"></script>
    <script src="/static/js/rdflib.js"></script>
    <script src="/static/js/jsproms.js"></script>
    <style>
        .entity-input-delete,
        .entity-output-delete,
        .entity-input-add,
        .entity-output-add {
            color: #0f4a84;
            cursor: pointer;
            text-decoration: underline;
        }
    </style>
    <script>

/*        var Agent;

        Agent = function (label, uri, givenName, familyName, mbox) {
        this.label = label;
        this.givenName = givenName;
        this.familyName = familyName;
        this.mbox = mbox;
        if (uri) {
            this.uri = uri;
        }
        // TODO: Fix up the uri
        else {
            this.uri = 'http://placeholder.org#';
        }
        };

        Agent.prototype.makeGraph = function() {

            //this.g = $rdf.graph();
                this.g = new $rdf.graph();

//        this.g.add($rdf.sym(this.uri), FOAF('name'), "Albert Bloggs");
            this.g.add($rdf.sym(this.uri), RDF('type'), PROV('Agent'));
            this.g.add($rdf.sym(this.uri), RDF('type'), PROV('Person'));

            this.g.add($rdf.sym(this.uri), FOAF('familyName'), this.familyName);
            this.g.add($rdf.sym(this.uri), FOAF('givenName'), this.givenName);
            this.g.add($rdf.sym(this.uri), FOAF('mbox'), this.mbox);

            return this.g;
            };

        Agent.prototype.get_graph = function () {
        if (!this.g) {
            this.makeGraph();

            return this.g;
            }
        };

        Agent.prototype.serialize_graph = function() {
            window.alert("test");
            Custg = Custodian.get_graph();
            var triples = new $rdf.Serializer(Custg).toN3(Custg);

            return triples;
        };
*/
        var entityInputCounter = 0;
        var entityOutputCounter = 0;
        $(function() {
            $('input[name=agent-new-existing]').change(function () {
                if ($('input[name=agent-new-existing]:checked', '#create-report').val() == "existing") {
                    $('#agent-existing-value').show();
                    $('#agent-new-value').hide();
                } else {
                    $('#agent-existing-value').hide();
                    $('#agent-new-value').show();
                }
            });

            $('#register-system').click(function(event) {
                event.preventDefault();
                // TODO: validate fields

                //var Custodian = new Agent('GA Agent', null, $('#agent-fname').val(), $('#agent-lname').val(), $('#agent-email').val());
                var Custodian = new Agent("some text", null, 'wilma', 'flinstone', 'wf@email.com');

                var RepSys = new ReportingSystem('some label', null, 'some comment', Custodian);
                var RSgraph = RepSys.get_graph();
                var triples = new $rdf.Serializer(RSgraph).toN3(RSgraph);


                var test = "@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> ." +
                        "@prefix dc: <http://purl.org/dc/elements/1.1/> ." +
                        "@prefix ex: <http://example.org/stuff/1.0/> . " +
                        "<http://www.w3.org/TR/rdf-syntax-grammar>" +
                        "dc:title \"RDF/XML Syntax Specification (Revised)\" ;ex:editor " +
                        "[ex:fullname \"Dave Beckett\";" +
                        "ex:homePage <http://purl.org/net/dajobe/>] .";

                //$.post('/id/reportingsystem/', data=test, headers={'Content-Type': 'text/turtle'});
                //response = $.post('/id/reportingsystem/', data=test, headers={'Content-Type': 'text/turtle'});



                console.log(triples);

                //if ($.post.status === 400) {
                //    alert($.post.response);
                //} else {
                //    alert('There was a problem with the request.');
                //}
                function responseFunction(response) {
                        //alert('test' + response);
                }

                // Post to Proms
                $.ajax({
                    type: 'POST',
                    datatype: 'text',
                    //url: '/id/reportingsystem/',
                    url: '/id/testreportingsystem/',
                    data: test,
                    headers: {'Content-Type': 'text/turtle'},
                    success : function(response) {
                        //alert("success: " +response);
                    },
                    error : function(response) {
                        //alert("error: " +response);
                    }
                });

                ///id/reportingsystem/ (p = requests.post('/id/reportingsystem/', data=the_turtle_data, headers={'Content-Type': 'text/turtle'})).

                //$.get('/id/testreportingsystem/', function(data, status){
                //    alert("Data: " + data + "\nStatus: " + status);
                //});

                $.ajax("/id/testreportingsystem/", {
                    success: function(data) {
                        alert($(data));
                    },
                    error: function() {
                        //$('#notification-bar').text('An error occurred');
                    }
                });
                //get_reportingsystems_dict

                $('#generated-results').text(triples);
                $('#generated-results').show();
            });


/*
            $('#generate-report').click(function(event) {
                event.preventDefault();
                //validate fields

                //construct the JSON object from form fields
                var form_parts_json_obj = new Object();
                form_parts_json_obj.agent_new_existing = $('input[name=agent-new-existing]:checked', '#create-report').val();
                form_parts_json_obj.agent = $('#agent').val();
                form_parts_json_obj.agent_name = $('#agent-name').val();
                form_parts_json_obj.agent_uri = $('#agent-uri').val();
                form_parts_json_obj.agent_email = $('#agent-email').val();
                form_parts_json_obj.report_type = $('#report-type').val();
                form_parts_json_obj.report_title = $('#report-title').val();
                form_parts_json_obj.report_reportingsystem = $('#report-reportingsystem').val();
                form_parts_json_obj.report_nativeId = $('#report-nativeId').val();
                form_parts_json_obj.activity_title = $('#activity-title').val();
                form_parts_json_obj.activity_description = $('#activity-description').val();
                form_parts_json_obj.activity_startedAtTime = $('#activity-startedAtTime').val();
                form_parts_json_obj.activity_endedAtTime = $('#activity-endedAtTime').val();

                console.log(form_parts_json_obj);
*/
                //post the JSON object to PROMS to convert it into Turtle
                /*
                $.ajax({
                    type: "POST",
                    url: url,
                    data: data,
                    success: success,
                    dataType: dataType
                });
                */

                  //show the results to the user
        //        $('#generated-results').text("This is text");
        //        $('#generated-results').show();
        //    });


        });


        function pad(n, width, z) {
            z = z || '0';
            n = n + '';
            return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
        }
    </script>
    <form id="register-system" action="/function/register_system" method="post">
        <table class="lined" style="width:860px;">
            <tr><td colspan="2"><h3>Agent</h3></td></tr>
            <tr>
                <th style="width:300px;">
                    Custodian:<br />
                    <span style="font-size:small; font-weight:normal;">Choose from the list of people or add in your details</span>
                </th>
                <td valign="top" style="width:560px;">
                    <p>
                        <input type="radio" name="agent-new-existing" value="existing" checked="checked" /> Existing <strong>or</strong>
                        <input type="radio" name="agent-new-existing" value="new" /> New
                    </p>

                    {%if agents|length>0%}
                    <div id="agent-existing-value" style="width:300px;">
                        <select name="agent" id="agent">
                            {% for key, value in agents.items() %}
                            <option value="{{ key }}">{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {%endif%}
                    <div id="agent-new-value" style="width:300px; display:none;">
                        <table class="layout">
                            <tr><td>First Name:</td><td><input id="agent-fname" name="agent-fname" type="text" /></td></tr>
                            <tr><td>Last Name:</td><td><input id="agent-lname" name="agent-lname" type="text" /></td></tr>
                            <tr><td>Email:</td><td><input id="agent-email" name="agent-email" type="text" /></td></tr>
                        </table>
                    </div>
                </td>
            </tr>
            <tr><td colspan="2"><h3>Reporting System</h3></td></tr>
            <tr><th>Name:<br /><span style="font-size:small; font-weight:normal;">A simple name for the <em>Reporting System</em>. </span></th>
                <td><input type="text" name="system-label" id="system-label" /></td></tr>
            <tr>
                <th>Reporting System URI:<br /><span style="font-size:small; font-weight:normal;">A valid link for the <em>Reporting System</em>. </span></th>
                <td><input type="text" name="system-uri" id="system-uri" /></td>
            </tr>
            <tr>
                <th>Reporting System Description:<br /><span style="font-size:small; font-weight:normal;">A simple description for the <em>Activity</em>.</span></th>
                <td><textarea name="system-comment" id="system-comment" style="width:230px;"></textarea></td>
            </tr>
            <tr>
                <th colspan="3" style="text-align:right;">
                    <br />
                    <button id="register-system">Register System</button><br />
                    <textarea id="generated-results" style="display:none; width:840px; height: 500px;"></textarea>
                    <button id="generate-report" style="display:none;">Store Report Here</button>
                </th>
            </tr>
        </table>
    </form>

{% endblock %}